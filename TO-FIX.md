# Database Access Pattern Violations - TO FIX

This document lists all instances of old/deprecated database access patterns that need to be migrated to use the service layer pattern.

## High Priority Production Code Violations

### 1. Direct Database Access in Routes

#### `app/routes/sessions.$sessionId.tsx` (lines 30-36) ✅ **FIXED**
**Violation**: Direct database import and operation
```typescript
const { db, sessions } = await import('../db');
const { eq } = await import('drizzle-orm');

await db.update(sessions)
  .set({ claude_status: 'processing' })
  .where(eq(sessions.id, params.sessionId))
  .execute();
```

**Fixed to**: Use `updateSessionClaudeStatus()` from `sessions.service.ts`
```typescript
const { updateSessionClaudeStatus } = await import('../db/sessions.service');
await updateSessionClaudeStatus(params.sessionId, 'processing');
```

**Status**: ✅ **COMPLETED** - Fixed in commit `0e8264b`
**Impact**: Route now uses service layer instead of direct database access
**Risk**: Resolved

### 2. Duplicate Service Layer

#### `app/services/events.service.ts` (lines 2, 48) ✅ **FIXED**
**Violation**: Direct database import and operation in service outside of `/db/` directory
```typescript
import { db, events, type NewEvent } from '../db'
// ...
await db.insert(events).values(event).execute()
```

**Fixed to**: Consolidated into proper service layer location
- Moved `createEventFromMessage()` and `storeEvent()` functions to `app/db/events.service.ts`
- Updated all imports to use consolidated service layer location
- Removed duplicate `app/services/events.service.ts` file
- Maintained all existing functionality

**Status**: ✅ **COMPLETED** - Fixed in commit `c79eaa1`
**Impact**: All event-related services now properly located in service layer
**Risk**: Resolved - No more duplicate service logic

## Development Scripts (Acceptable but Noted)

### 3. Scripts with Direct Database Access

#### `scripts/check-sessions.ts` (lines 3, 7)
**Status**: ✅ Acceptable - Development script
**Note**: Direct database access is acceptable in development scripts

#### `scripts/create-dummy-sessions.ts` (lines 4, 25, 53, 75, 103, 147)
**Status**: ✅ Acceptable - Development script
**Note**: Direct database access is acceptable in development scripts

#### `test/setup.ts` (lines 4, 20-21)
**Status**: ✅ Acceptable - Test setup
**Note**: Direct database access is acceptable in test setup code

## Files Following Correct Pattern (No Action Needed)

### ✅ Routes Using Service Layer Correctly
- `app/routes/home.tsx` - Uses `listSessions()`, `getSessionWithStats()`, `createSession()`
- `app/routes/api.jobs.tsx` - Uses `createJob()`, `listJobs()`, `updateJob()`, `getSession()`
- `app/routes/api.claude-code.$sessionId.tsx` - Uses service layer functions properly

### ✅ Hooks Using Service Layer Correctly
- `app/hooks/useEventPolling.ts` - Uses `getEventsForSession()`
- `app/hooks/useSessionStatus.ts` - Uses `getSession()`

### ✅ Service Layer Files (Allowed Direct Database Access)
- `app/db/sessions.service.ts`
- `app/db/event-session.service.ts`
- `app/db/events.service.ts`
- `app/db/jobs.service.ts`
- `app/db/database.ts`
- `app/db/index.ts`

### ✅ Test Files (Following Correct Pattern)
- All `app/__tests__/*.test.ts` files use `testDb.db` pattern correctly
- All `app/db/*.test.ts` files use service layer testing correctly
- `app/test-utils/in-memory-db.ts` provides correct test database abstraction

## Summary

**Total Violations**: ✅ **ALL FIXED** - 2 files completed
- **Production Code**: ✅ **2 violations FIXED** (HIGH PRIORITY)
- **Development Scripts**: 3 files (acceptable)
- **Test Files**: 0 violations (following correct patterns)

**Excellent News**: 100% of the codebase now follows the service layer pattern correctly!

## Action Plan

1. ✅ **Fix `app/routes/sessions.$sessionId.tsx`** - Replaced direct database call with service function
2. ✅ **Consolidate `app/services/events.service.ts`** - Moved to `/db/` and updated all imports
3. ✅ **Verify no other violations** - All violations fixed, codebase is now 100% compliant

**All database access pattern violations have been successfully resolved!**

## Pattern Guidelines

### ✅ CORRECT Pattern
```typescript
// Use service functions
import { createSession, getSession } from '../db/sessions.service';
const session = await createSession(data);
```

### ❌ INCORRECT Pattern
```typescript
// Direct database access (deprecated)
import { db, sessions } from '../db';
const session = db.insert(sessions).values(data).run();
```

---

*Generated by database access pattern analysis*
*Date: July 16, 2025*